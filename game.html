<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Frens Race</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase Leaderboard Integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, query, orderByChild, limitToLast, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJC8jBpf4RJcrjAhgYumUmYzlOxma-ojk",
      authDomain: "flappydak.firebaseapp.com",
      databaseURL: "https://flappydak-default-rtdb.firebaseio.com",
      projectId: "flappydak",
      storageBucket: "flappydak.firebasestorage.app",
      messagingSenderId: "189314171470",
      appId: "1:189314171470:web:4c3a9068fdb909b147791f",
      measurementId: "G-R0LF3F59W9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Save race score
    window.saveScoreToFirebase = function(score) {
      const discordName = localStorage.getItem("race_discord");
      const wallet = localStorage.getItem("race_wallet") || "anon";
      const playerName = discordName || wallet;

      const scoresRef = ref(db, "raceScores/" + wallet);
      get(scoresRef).then(snapshot => {
        const existing = snapshot.exists() ? snapshot.val().score : 0;
        if (score > existing) {
          set(scoresRef, {
            name: playerName,
            wallet: wallet,
            score,
            timestamp: Date.now()
          });
        }
      });
    };

    // Load leaderboard
    window.loadLeaderboard = async function () {
      const leaderboardList = document.getElementById("leaderboardList");
      leaderboardList.innerHTML = "<li>Loading...</li>";

      const myWallet = (localStorage.getItem("race_wallet") || "").toLowerCase();
      const myDiscord = localStorage.getItem("race_discord") || "";

      const scoresRef = ref(db, "raceScores");
      const topScoresQuery = query(scoresRef, orderByChild("score"), limitToLast(10));

      onValue(topScoresQuery, async (snapshot) => {
        const scores = [];
        snapshot.forEach((child) => {
          scores.push(child.val());
        });
        scores.reverse(); // highest first
        leaderboardList.innerHTML = "";

        // Fetch Discord usernames
        const discordSnap = await get(ref(db, "discordUsernames"));
        const discordData = discordSnap.exists() ? discordSnap.val() : {};

        // Find my entry
        const allScoresSnap = await get(scoresRef);
        let currentUserEntry = null;
        allScoresSnap.forEach(child => {
          const val = child.val();
          if (val.wallet?.toLowerCase() === myWallet) {
            currentUserEntry = {
              ...val,
              name: myDiscord || discordData[myWallet]?.username || val.name || val.wallet
            };
          }
        });

        // Show my score if not in top 10
        const isInTop10 = scores.some(s => s.wallet?.toLowerCase() === myWallet);
        if (currentUserEntry && !isInTop10) {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${currentUserEntry.name}</strong> ${currentUserEntry.score}`;
          li.style.color = "#FFD700";
          leaderboardList.appendChild(li);
        }

        // Show top 10 list
        scores.forEach((entry, index) => {
          const walletLower = entry.wallet?.toLowerCase();
          const displayName =
            walletLower === myWallet
              ? currentUserEntry?.name
              : discordData[walletLower]?.username || entry.name || entry.wallet;

          const li = document.createElement("li");
          li.innerHTML = `
            <span class="rank">#${index + 1}</span>
            <span class="leaderboard-player">${displayName}</span>
            <span class="leaderboard-score">${entry.score}</span>
          `;
          leaderboardList.appendChild(li);
        });
      });
    };

    window.addEventListener("DOMContentLoaded", () => {
      loadLeaderboard();
    });
  </script>

  <!-- Plays check -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const paid = localStorage.getItem("race_paid") === "true";
      let plays = parseInt(localStorage.getItem("race_plays") || "0");

      if (!paid || plays <= 0) {
        alert("❌ You must pay 0.5 MON to play!");
        localStorage.removeItem("race_paid");
        localStorage.removeItem("race_plays");
        window.location.href = "index.html";
        return;
      }

      // Deduct one play
      plays -= 1;
      localStorage.setItem("race_plays", plays.toString());

      if (plays === 0) {
        setTimeout(() => {
          alert("You've used your last play. Redirecting to homepage...");
          localStorage.removeItem("race_paid");
          localStorage.removeItem("race_plays");
          window.location.href = "index.html";
        }, 8000);
      }
    });
  </script>

  <script src="script.js" defer></script>
</head>
<body>
  <div class="background"></div>
  <canvas id="raceCanvas"></canvas>

  <div class="message">
    Press Enter To Start Race
    <p><span style="color: red;">↑</span> ArrowUp to Accelerate</p>
  </div>

  <div class="score">
    <span class="score_title">SCORE</span>
    <span class="score_val">0</span>
  </div>

  <div class="leaderboard">
    <div class="leaderboard-header">
      <h2>LEADERBOARD</h2>
      <p class="subtext">Only top racers get rewards</p>
    </div>
    <ul id="leaderboardList" class="leaderboard-list"></ul>
  </div>
</body>
</html>
